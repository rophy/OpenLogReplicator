-- timestamp-variants.sql: Test TIMESTAMP with various precisions and DATE edge cases.
-- Run as PDB user (e.g., olr_test/olr_test@//host:1521/ORCLPDB)
--
-- Note: TIMESTAMP WITH TIME ZONE, INTERVAL YEAR TO MONTH, and INTERVAL DAY TO SECOND
-- are not tested here because logminer2json.py doesn't yet parse TO_TIMESTAMP_TZ(),
-- TO_YMINTERVAL(), and TO_DSINTERVAL() functions.
--
-- Outputs: FIXTURE_SCN_START: <scn> and FIXTURE_SCN_END: <scn>

SET SERVEROUTPUT ON
SET FEEDBACK OFF
SET ECHO OFF

-- Setup: drop and recreate table
DECLARE
    v_table_exists NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_table_exists
    FROM user_tables WHERE table_name = 'TEST_TIMESTAMPS';
    IF v_table_exists > 0 THEN
        EXECUTE IMMEDIATE 'DROP TABLE TEST_TIMESTAMPS PURGE';
    END IF;
END;
/

CREATE TABLE TEST_TIMESTAMPS (
    id         NUMBER PRIMARY KEY,
    col_date   DATE,
    col_ts0    TIMESTAMP(0),
    col_ts3    TIMESTAMP(3),
    col_ts6    TIMESTAMP(6),
    col_ts9    TIMESTAMP(9)
);

ALTER TABLE TEST_TIMESTAMPS ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;

-- Record start SCN
DECLARE
    v_start_scn NUMBER;
BEGIN
    SELECT current_scn INTO v_start_scn FROM v$database;
    DBMS_OUTPUT.PUT_LINE('FIXTURE_SCN_START: ' || v_start_scn);
END;
/

-- DML: INSERT with various precisions
INSERT INTO TEST_TIMESTAMPS VALUES (1,
    TO_DATE('2025-06-15 10:30:00', 'YYYY-MM-DD HH24:MI:SS'),
    TO_TIMESTAMP('2025-06-15 10:30:00', 'YYYY-MM-DD HH24:MI:SS'),
    TO_TIMESTAMP('2025-06-15 10:30:00.123', 'YYYY-MM-DD HH24:MI:SS.FF3'),
    TO_TIMESTAMP('2025-06-15 10:30:00.123456', 'YYYY-MM-DD HH24:MI:SS.FF6'),
    TO_TIMESTAMP('2025-06-15 10:30:00.123456789', 'YYYY-MM-DD HH24:MI:SS.FF9')
);
COMMIT;

-- DML: INSERT midnight/epoch values
INSERT INTO TEST_TIMESTAMPS VALUES (2,
    TO_DATE('2000-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS'),
    TO_TIMESTAMP('2000-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS'),
    TO_TIMESTAMP('2000-01-01 00:00:00.000', 'YYYY-MM-DD HH24:MI:SS.FF3'),
    TO_TIMESTAMP('2000-01-01 00:00:00.000000', 'YYYY-MM-DD HH24:MI:SS.FF6'),
    TO_TIMESTAMP('2000-01-01 00:00:00.000000000', 'YYYY-MM-DD HH24:MI:SS.FF9')
);
COMMIT;

-- DML: INSERT end-of-day values
INSERT INTO TEST_TIMESTAMPS VALUES (3,
    TO_DATE('2026-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS'),
    TO_TIMESTAMP('2026-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS'),
    TO_TIMESTAMP('2026-12-31 23:59:59.999', 'YYYY-MM-DD HH24:MI:SS.FF3'),
    TO_TIMESTAMP('2026-12-31 23:59:59.999999', 'YYYY-MM-DD HH24:MI:SS.FF6'),
    TO_TIMESTAMP('2026-12-31 23:59:59.999999999', 'YYYY-MM-DD HH24:MI:SS.FF9')
);
COMMIT;

-- DML: INSERT with NULL timestamps
INSERT INTO TEST_TIMESTAMPS VALUES (4, NULL, NULL, NULL, NULL, NULL);
COMMIT;

-- DML: UPDATE timestamp values
UPDATE TEST_TIMESTAMPS SET
    col_date = TO_DATE('2026-03-01 08:00:00', 'YYYY-MM-DD HH24:MI:SS'),
    col_ts3  = TO_TIMESTAMP('2026-03-01 08:00:00.500', 'YYYY-MM-DD HH24:MI:SS.FF3'),
    col_ts6  = TO_TIMESTAMP('2026-03-01 08:00:00.654321', 'YYYY-MM-DD HH24:MI:SS.FF6'),
    col_ts9  = TO_TIMESTAMP('2026-03-01 08:00:00.987654321', 'YYYY-MM-DD HH24:MI:SS.FF9')
WHERE id = 1;
COMMIT;

-- DML: UPDATE NULL to value
UPDATE TEST_TIMESTAMPS SET
    col_date = TO_DATE('2025-01-15 12:00:00', 'YYYY-MM-DD HH24:MI:SS'),
    col_ts6  = TO_TIMESTAMP('2025-01-15 12:00:00.000001', 'YYYY-MM-DD HH24:MI:SS.FF6')
WHERE id = 4;
COMMIT;

-- DML: DELETE
DELETE FROM TEST_TIMESTAMPS WHERE id = 2;
COMMIT;

-- Record end SCN
DECLARE
    v_end_scn NUMBER;
BEGIN
    SELECT current_scn INTO v_end_scn FROM v$database;
    DBMS_OUTPUT.PUT_LINE('FIXTURE_SCN_END: ' || v_end_scn);
END;
/

EXIT
